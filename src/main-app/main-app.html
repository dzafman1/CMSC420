<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!--file uploader component-->
<link rel="import" href="../../bower_components/yo-file-uploader/yo-file-uploader.html">

<!--d3 parser for csv-->
<!-- <script src="../../libs/d3-dsv.js"></script> -->

<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<!--iron-ajax-->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../bower_components/neon-animation/web-animations.html">

<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../bower_components/data-filter/data-filter.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/isw-dropdown-menu/isw-dropdown-menu.html">

<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">

<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">

<!-- customized html elements -->
<link rel="import" href="./analysis-tab.html">
<link rel="import" href="./suggest-panel.html">

<dom-module id="main-app">
  <template>
    <style>
      :host {
        display: block;
        font-family: 'Open Sans', sans-serif;

      }

      iron-selector>* {
        padding: 8px;
      }

      .iron-selected {
        background-color: var(--google-blue-500);
        color: white;
      }

      app-header {
        /*position: fixed;*/
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--paper-blue-grey-50);

        /*--app-header-background-front-layer: {*/
        /*background-color: red;*/
        /*};*/
        /*--app-header-background-rear-layer: {*/
        /*background-color: blue;*/
        /*};*/
      }

      .header-bar-height {
        height: 70px;
      }

      paper-dropdown-menu {
        margin-left: 70px;
        /* margin-right: auto; */
        width: 300px;
      }

      paper-icon-item,
      paper-item {
        max-width: 200px;
      }

      yo-file-uploader {
        width: 200px;
        display: inline-block;
      }

      isw-dropdown-menu {
        display: inline-block;
        margin-right: 30px;
        width: 350px;
      }

      analysis-tab {
        /* margin-top: 5px; */
        margin-bottom: 5px;
        border-radius: 5px;
        border: thick solid rgb(226, 225, 225);
        /* max-height: 400px; */
        /* overflow-y: auto; */
      }

      suggest-panel {
        margin-top: 5px;
        margin-bottom: 5px;
        border: solid rgb(226, 225, 225);
        border-radius: 5px;
      }

      iron-icon.checkbox.checked {
        color: #00508C;
      }

      iron-icon.checkbox.unchecked {
        color: var(--secondary-text-color);
      }

      paper-icon-item iron-icon.checkbox.checked {
        display: none;
      }

      paper-icon-item iron-icon.checkbox.unchecked {
        display: block;
      }

      paper-icon-item.iron-selected iron-icon.checkbox.checked {
        display: block;
      }

      paper-icon-item.iron-selected iron-icon.checkbox.unchecked {
        display: none;
      }
    </style>
    <iron-ajax id="httpRequest" url="http://localhost:5000/datasets" params='' handle-as="json"
      on-response="handleResponse" debounce-duration="300">
    </iron-ajax>
    <iron-ajax id="computeRequest" url="http://localhost:5000/compute" params='' handle-as="json"
      on-response="handleComputeResponse" debounce-duration="300">
    </iron-ajax>

    <iron-ajax id="calculateIntermediateRequest" url="http://localhost:5000/calculate" params='' handle-as="json"
      on-response="handleComputeResponse" debounce-duration="300">
    </iron-ajax>

    <!-- might have to do same to get intermediate dataframe loaded-->
    <iron-ajax id="dataLoadRequest" url="http://localhost:5000/dataload" params='' handle-as="json"
      on-response="dataLoadedResponse" debounce-duration="3000">
    </iron-ajax>

    <iron-ajax id="intermediateDataRequest" url="http://localhost:5000/intermediatedata" params='' handle-as="json"
      on-response="intermediateDataResponse" debounce-duration="3000">
    </iron-ajax>
    <app-header-layout id="app-header" fullbleed>

      <app-header class="header-bar-height" slot="header" fixed>

        <app-toolbar class="header-bar-height">
          <iron-icon src=../../icons/lodestar-logo.png style="height: 48px; width: 48px;"> </iron-icon>
          <div style="font-size: 28px;">Lodestar</div>
          <paper-dropdown-menu class="dataset-dropdown-menu" label="Select A Dataset" vertical-offset="60">
            <paper-listbox slot="dropdown-content" selected="{{selectedDataset}}" attr-for-selected="label"
              on-selected-changed="datasetChanged">
              <dom-repeat items="[[datasetList]]" as="item">
                <template>
                  <paper-item label=[[item]]>
                    [[item]]
                  </paper-item>
                </template>
              </dom-repeat>
            </paper-listbox>
          </paper-dropdown-menu>

          <!-- <paper-dropdown-menu class="dataframe-dropdown-menu" label="Select A Dataframe" vertical-offset="60">
            <paper-listbox slot="dropdown-content" selected="{{selectedDataframe}}" attr-for-selected="label"
              on-selected-changed="dataframeChanged">
              <dom-repeat items="[[dataframeList]]" as="item">
                <template>
                  <paper-item label=[[item]]>
                    [[item]]
                  </paper-item>
                </template>
              </dom-repeat>
            </paper-listbox>
          </paper-dropdown-menu> -->

        </app-toolbar>


      </app-header>

    </app-header-layout>

    <!-- file uploader -->
    <!-- <yo-file-uploader accept="text/*"></yo-file-uploader> -->
    <!-- <paper-icon-button icon="file-upload" on-click="_fileUpload"></paper-icon-button> -->

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class MainApp extends Polymer.Element {
      static get is() { return 'main-app'; }
      static get properties() {
        return {
          //adding list for dataframe

          selectedDataframe: {
            type: String,
            value: null,
            notify: true
          },

          selectedDataset: {
            type: String,
            value: '',
            notify: true
          },

          datasetList: {
            type: Array,
            value: [],
          },
          currentState: {
            type: String,
            value: "",
            notify: true
          },

          dataframeList: {
            type: Array,
            value: [],
          },

          allTabsList: {
            type: Array,
            value: [],
          },

          selectedSuggestAnalysis: {
            type: String,
            value: "",
            notify: true
          },

          numberOfSteps: {
            type: Number,
            value: 0,
            notify: true
          },
          numberOfStepsSuggest: {
            type: Number,
            value: 0,
            notify: true
          }

        };
      }

      // intermediateDataRequest() {
      //   var requestElement = this.shadowRoot.getElementById("intermediateLoadRequest"); 
      //   requestElement.params = {
      //     type: 'request'
      //   }; 
      //   requestElement.generateRequest();

      // }


      // calculateIntermediateResponse(e) {
      //   var response = e.detail.response; 
      //   var self = this; 
      //   if (response['type'] === 'calculate') {
      //     //do something
      //   }

      // }

      // populateIntermediate() {
      //   var select = this.shadowRoot.getElementById("selectDataframe");
      //   var opt = this.dataframeList[this.dataframeList.length-1];
      //   var el = document.createElement("paper-item");
      //   el.textContent = opt;
      //   el.value = opt;
      //   select.appendChild(el);

      // }
      connectedCallback() {
        super.connectedCallback();

        // send out the request for list of datasets
        var requestElement = this.shadowRoot.getElementById("httpRequest");
        requestElement.generateRequest();
        var self = this;
        self.addEventListener('selected-analysis', self.suggestionSelected.bind(self));
        self.addEventListener('delete-analysis-cell', self.removeAnalysisTab.bind(self));
        self.addEventListener('export-data', self.exportData.bind(self));

        //event listener for deleton of downstream tabs if needed
        self.addEventListener('delete-downstream', self.deleteDownstream.bind(self));

      }

      handleResponse(e) {
        var responseDetail = e.detail;
        if (responseDetail.url === 'http://localhost:5000/datasets') {
          console.log(responseDetail.response);
          this.datasetList = responseDetail.response;
        }
        // if (responseDetail.url === 'http://localhost:5000/intermediaterequest') {
        //   this.dataframeList = responseDetail.response; 
        // }
      }

      dataLoadedResponse(e) {
        console.log(e);
        // keep empty for now
      }

      intermediateDataResponse(e) {
        var response = e.detail.response;
        var self = this;
        if (response['type'] == 'export') {
          self.downloadCSV(JSON.parse(response['data']));
        }
      }

      handleComputeResponse(e) {
        var response = e.detail.response;
        console.log(e.detail.response);
        var self = this;

        //check for error in codeblock execution
        if (response.type == 'error') {
          console.log("error occurred");
          //should display error message to user  - right now just logs error 
          // this.shadowRoot.getElementById('error-toast').show();
          // this.errorToast.open();

        } else if (response.type == 'suggest') {
          var manualSuggestList = response.manual_result;
          var crowdSuggestList = response.crowd_result;
          var analysesList = response.all_analysis;
          console.log(manualSuggestList);
          self.numberOfStepsSuggest += 1;
          var suggestElement = document.createElement('suggest-panel');
          suggestElement.setAttribute('id', 'suggest-panel-' + self.numberOfStepsSuggest);
          suggestElement.setAttribute('manual-suggest-list', JSON.stringify(manualSuggestList));
          suggestElement.setAttribute('crowd-suggest-list', JSON.stringify(crowdSuggestList));
          suggestElement.setAttribute('all-analysis-list', JSON.stringify(analysesList));
          self.shadowRoot.getElementById('app-header').appendChild(suggestElement);
          // self.dataframeList.push("suggest-panel-"+self.numberOfSteps);
          self.allTabsList.push(suggestElement);

          console.log("DATAFRAME LISt: " + self.dataframeList);

        } else if (response.type == 'shuffle-split' || response.type == 'fit-decision-tree' ||
          response.type == "predict-test") {
          var result = response.result;
          console.log(result);
          //self.numberOfSteps - id for each intermediate dataframe
          var analysisTab = document.createElement('analysis-tab');
          console.log("Number of steps: " + self.numberOfSteps);
          self.numberOfSteps += 1;

          analysisTab.setAttribute('id', 'analysis-tab-' + self.numberOfSteps);
          analysisTab.setAttribute('type', response.type);
          analysisTab.setAttribute('result', JSON.stringify(result));
          analysisTab.setAttribute('output', response.output);
          self.shadowRoot.getElementById('app-header').appendChild(analysisTab);

          //adding new analysis tab to list of analysis tabs currently created
          // self.dataframeList.push(self.numberOfSteps); 
          self.allTabsList.push(analysisTab);

          this.push('dataframeList', self.numberOfSteps);
          console.log("DATAFRAME LIST: " + "analysis-tab-" + self.dataframeList);
          // this.populateIntermediate();

          this._sendComputeRequest(this.selectedDataset, response.type, 'suggest');
          setTimeout(function () {
            analysisTab.scrollIntoView();
          }, 100);
        }
        else {
          var result = [];
          if (typeof (response.result) == 'string') {
            result.push(JSON.parse(response.result));
          } else {
            response.result.forEach(function (element) {
              result.push(window.btoa(window.atob(element)));
            });
          }
          console.log(result);
          var analysisTab = document.createElement('analysis-tab');
          self.numberOfSteps += 1;
          analysisTab.setAttribute('id', 'analysis-tab-' + self.numberOfSteps);
          analysisTab.setAttribute('type', response.type);
          analysisTab.setAttribute('result', JSON.stringify(result));
          analysisTab.setAttribute('output', response.output);
          analysisTab.setAttribute('description', response.description);
          analysisTab.setAttribute('code', response.code);
          self.shadowRoot.getElementById('app-header').appendChild(analysisTab);

          //adding new analysis tab to list of all analysis tabs currently created
          // self.dataframeList.push(self.numberOfSteps); 
          self.allTabsList.push(analysisTab);
          this.push('dataframeList', "analysis-tab-" + self.numberOfSteps);
          console.log("DATAFRAME LIST: " + self.dataframeList);
          // this.populateIntermediate();

          this._sendComputeRequest(this.selectedDataset, response.type, 'suggest');

          setTimeout(function () {
            analysisTab.scrollIntoView();
          }, 100);
        }
        // } else if (response.type == 'ml-scatterplot-regression') {
        //   var data = response.result;
        //   console.log(data);
        //   var self = this;
        //   var count = 0;

        //   data.forEach(function (image_element) {
        //     var newImageElement = document.createElement('img');

        //     newImageElement.setAttribute('src', "data:image/png;base64," + window.btoa(window.atob(image_element)));
        //     newImageElement.setAttribute('id', 'img-' + response.type + '-' + count);

        //     self.shadowRoot.appendChild(newImageElement);
        //   });

        //   this._sendComputeRequest(this.selectedDataset, response.type, 'suggest');

        // } else if (response.type == 'feature-selection') {
        //   var data = response.result;
        //   console.log(data);
        //   var self = this;

        //   // dropdown menu for feature selections
        //   var newFeatureSelectionElement = document.createElement('isw-dropdown-menu');
        //   newFeatureSelectionElement.setAttribute('id', 'dropdown-feature-selection');
        //   newFeatureSelectionElement.setAttribute('attr-for-selected', 'value');
        //   newFeatureSelectionElement.setAttribute('label', 'select attributes as features');
        //   newFeatureSelectionElement.setAttribute('multi', '');

        //   // dropdown menu for target attribute selection
        //   var newTargetAttributeElement = document.createElement('isw-dropdown-menu');
        //   newTargetAttributeElement.setAttribute('id', 'dropdown-target-selection');
        //   newTargetAttributeElement.setAttribute('attr-for-selected', 'value');
        //   newTargetAttributeElement.setAttribute('label', 'select attributes as target');


        //   data.forEach(item => {
        //     var iconItem = document.createElement("paper-icon-item");
        //     iconItem.setAttribute('value', item);
        //     iconItem.setAttribute('label', item);

        //     var iconUnchecked = document.createElement('iron-icon');
        //     iconUnchecked.setAttribute('class', 'checkbox unchecked');
        //     iconUnchecked.setAttribute('icon', 'check-box-outline-blank');
        //     iconUnchecked.setAttribute('slot', 'item-icon');

        //     var iconChecked = document.createElement('iron-icon');
        //     iconChecked.setAttribute('class', 'checkbox checked');
        //     iconChecked.setAttribute('icon', 'check-box');
        //     iconChecked.setAttribute('slot', 'item-icon');

        //     var itemBody = document.createElement('paper-item-body');
        //     var divContent = document.createElement('div');
        //     divContent.textContent = item;
        //     itemBody.appendChild(divContent);

        //     iconItem.appendChild(iconChecked);
        //     iconItem.appendChild(iconUnchecked);
        //     iconItem.appendChild(itemBody);

        //     newFeatureSelectionElement.appendChild(iconItem);

        //     var paperItem = document.createElement('paper-item');
        //     paperItem.setAttribute('value', item);
        //     paperItem.textContent = item;
        //     newTargetAttributeElement.appendChild(paperItem);
        //   });

        //   var updateButton = document.createElement('paper-button');

        //   updateButton.textContent = 'Update Selections!';

        //   var groupElement = document.createElement('div');
        //   groupElement.appendChild(newFeatureSelectionElement);
        //   groupElement.appendChild(newTargetAttributeElement);
        //   groupElement.appendChild(updateButton);

        //   this.shadowRoot.appendChild(groupElement);

        //   updateButton.addEventListener('click', self.featureSelected.bind(self));

        // }

      }

      //handles dataframe dropdown selection
      dataframeChanged(e) {
        // var intermediate_idx = document.getElementById("selectDataframe").value;
        console.log("sending intermediate request");
        this.selectedDataframe = e.detail.value;
        var intermediate_idx = this.selectedDataframe;

        var selected_tab = this.shadowRoot.getElementById(this.selectedDataframe);

        //gets output dataframe from selected analysis tab
        var frame_data = selected_tab.output;
        console.log("JSON DATA");
        console.log(frame_data);
        console.log("TYPE: ");

        //Retrieves output dataframe of selected analysis tab
        var converted = JSON.parse(frame_data);
        console.log(converted.data);

        // var analysis_recommendations = this.shadowRoot.getElementById("suugest-panel-"+this.numberOfSteps);

        var requestElement = this.shadowRoot.getElementById("calculateIntermediateRequest");
        // console.log("JSON DATA");
        // console.log(typeof frame_data.data);

        console.log("Chosen Analysis");
        console.log(this.selectedSuggestAnalysis);

        requestElement.params = {
          index: intermediate_idx,
          dataset: this.selectedDataset,
          state: JSON.stringify(this.currentState),
          dataframe: JSON.stringify(converted.data),
          compute: this.selectedSuggestAnalysis
        };
        requestElement.generateRequest();
      }

      deleteDownstream(e) {
        //first check if selected > 1 - if so then set timeout for x secs and delete from the all tabs list 
        //check first here
        //if true - delete tabs within a time out function here 
        var self = this;
        var elementList = self.shadowRoot.querySelector('app-header-layout').children;
        var tab_id = e.path[0].id;

        console.log("TAB ID: " + tab_id);

        var tab_num = parseInt(tab_id[tab_id.length - 1]);
        var current_suggest_tab = this.shadowRoot.getElementById(tab_id);
        console.log("TAB CHILDREN: " + current_suggest_tab.numberOfRecsSelected);

        if (current_suggest_tab.numberOfRecsSelected > 1) {
          var targetIdx = -1;

          for (var i = 0; i < elementList.length; i++) {
            if (elementList[i].id == e.path[0].id) {
              targetIdx = i + 1;
              break;
            }
          }
          // remove all the following items
          for (var i = elementList.length - 1; i >= targetIdx; i--) {
            elementList[targetIdx].remove();
          }

          var idList = e.path[0].id.split('-');
          var index = idList[idList.length - 1];

          // var recentSuggestTab = elementList[targetIdx - 1];
          // recentSuggestTab.enableSuggestions();

          // send a request to server to delete intermediate dataframe too!
          var requestElement = this.shadowRoot.getElementById("intermediateDataRequest");
          requestElement.params = {
            index: index,
            type: 'delete'
          };
          requestElement.generateRequest();
        }
      }

      datasetChanged(e) {
        this.selectedDataset = e.detail.value;
        console.log(e.detail.value);
        // send out data loading request, NOTE: not working as expected though
        var requestElement = this.shadowRoot.getElementById("dataLoadRequest");
        requestElement.params = {
          dataset: this.selectedDataset
        };

        var self = this;
        requestElement.generateRequest();
        self._sendComputeRequest(self.selectedDataset, '', 'suggest');
      }

      suggestionSelected(e) {
        var sValue = e.detail.value;
        if (sValue) {
          this.selectedSuggestAnalysis = e.detail.value;

          this._sendComputeRequest(this.selectedDataset, '', this.selectedSuggestAnalysis);
          console.log(this.selectedSuggestAnalysis);
        }
      }

      removeAnalysisTab(e) {
        var self = this;
        var elementList = this.shadowRoot.querySelector('app-header-layout').children;
        var targetIdx = -1;

        for (var i = 0; i < elementList.length; i++) {
          if (elementList[i].id == e.path[0].id) {
            targetIdx = i;
            break;
          }
        }

        // remove all the following items
        for (var i = elementList.length - 1; i >= targetIdx; i--) {
          elementList[targetIdx].remove();
        }

        var idList = e.path[0].id.split('-');
        var index = idList[idList.length - 1];

        var recentSuggestTab = elementList[targetIdx - 1];
        recentSuggestTab.enableSuggestions();

        // send a request to server to delete intermediate dataframe too!
        var requestElement = this.shadowRoot.getElementById("intermediateDataRequest");
        requestElement.params = {
          index: index,
          type: 'delete'
        };
        requestElement.generateRequest();
      }

      exportData(e) {
        var idList = e.path[0].id.split('-');
        var index = idList[idList.length - 1];        // send a request to server to export intermediate dataframe
        var requestElement = this.shadowRoot.getElementById("intermediateDataRequest");
        requestElement.params = {
          index: index,
          type: 'export'
        };
        requestElement.generateRequest();
      }

      clickOnAttribute(e) {
        console.log(e.target.id);
        var element_id = e.target.id;
        this.selectedSuggestAnalysis = element_id.substring(element_id.indexOf('-') + 1);

        this._sendComputeRequest(this.selectedDataset, '', this.selectedSuggestAnalysis);
        console.log(this.selectedSuggestAnalysis);
      }

      // feature selection event listener
      featureSelected(e) {
        var featureDropdown = this.shadowRoot.getElementById("dropdown-feature-selection");
        var targetDropdown = this.shadowRoot.getElementById("dropdown-target-selection");

        var features_list = [];
        featureDropdown['value'].split(',').forEach(function (feature) {
          features_list.push(feature.trim());
        });

        var state = {
          'features': features_list,
          'target': targetDropdown['value']
        };
        this.currentState = state;

        this._sendComputeRequest(this.selectedDataset, state, 'scatterplot-regression');

      }

      downloadCSV(responseData) {
        var data, filename, link;
        var csv = this._convertArrayOfObjectsToCSV({
          data: responseData
        });
        if (csv == null) return;

        filename = 'export.csv';

        if (!csv.match(/^data:text\/csv/i)) {
          csv = 'data:text/csv;charset=utf-8,' + csv;
        }
        data = encodeURI(csv);

        link = document.createElement('a');
        link.setAttribute('href', data);
        link.setAttribute('download', filename);
        link.click();
        document.body.removeChild(link);
      }

      _convertArrayOfObjectsToCSV(args) {
        var result, ctr, keys, columnDelimiter, lineDelimiter, data;

        data = args.data || null;
        if (data == null || !data.length) {
          return null;
        }

        columnDelimiter = args.columnDelimiter || ',';
        lineDelimiter = args.lineDelimiter || '\n';

        keys = Object.keys(data[0]);

        result = '';
        result += keys.join(columnDelimiter);
        result += lineDelimiter;

        data.forEach(function (item) {
          ctr = 0;
          keys.forEach(function (key) {
            if (ctr > 0) result += columnDelimiter;

            result += item[key];
            ctr++;
          });
          result += lineDelimiter;
        });

        return result;
      }

      _sendComputeRequest(dataset, state, computeType) {
        // send out the request for list of datasets
        var requestElement = this.shadowRoot.getElementById("computeRequest");
        console.log("This is the state:" + state);
        this.currentState = state;
        console.log("This is the current state: " + this.currentState);

        //get most recent analysis tab
        var selected_tab = this.shadowRoot.getElementById("analysis-tab-" + this.numberOfSteps);

        //gets output dataframe from selected analysis tab
        var next_frame_data = null;
        var converted_next_frame = null;

        //if selected tab null - means there has been no analysis tabs generated yet...or some other error
        //NOTE: this is a bug 
        if (selected_tab !== null) {
          //grab the output dataframe from most recent tab
          next_frame_data = selected_tab.output;
          console.log("JSON DATA");
          console.log(next_frame_data)
          console.log("TYPE: ");

          //Retrieves output dataframe of selected analysis tab
          converted_next_frame = JSON.parse(next_frame_data);
          console.log("success intermediate frame sent");
        }


        // console.log(typeof this.numberOfSteps);

        if (converted_next_frame === null) {
          converted_next_frame = {};
          converted_next_frame['data'] = "null";
          // converted_next_frame = JSON.parse(converted_next_frame); 
        }

        console.log("Current Dataframe:")
        console.log(converted_next_frame.data)
        var steps = this.numberOfSteps;

        requestElement.params = {
          dataset: dataset,
          state: JSON.stringify(state),
          dataframe: JSON.stringify(converted_next_frame.data),
          compute: computeType,
          steps: steps
        };
        requestElement.generateRequest();
      }

      _fileHandler(e) {
        // keep empty for now
      }

      _fileUpload(e) {
        var reader = new FileReader();

        var uploadFile = this.shadowRoot.querySelector("yo-file-uploader");
        console.log(uploadFile.files);

        var reader = new FileReader();

        reader.readAsBinaryString(uploadFile.files[0]);

        var self = this;

        // onload function will be called automatically by the browser,
        // we do not need to call it explicitly
        reader.onload = function () {
          // transfer data to the server
          var requestElement = self.shadowRoot.getElementById("dataLoadRequest");
          requestElement.params = {
            data: reader.result
          };
          requestElement.generateRequest();

        }

      }


    }

    window.customElements.define(MainApp.is, MainApp);
  </script>
</dom-module>